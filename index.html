<html>
<head>
<script src="js/jquery-1.5.1.min.js"></script>
<script src="jquery.mousewheel.min.js"></script>
<link rel="stylesheet" href="css/smoothness/jquery-ui-1.8.13.custom.css">  
<link rel="stylesheet" href="css/dev.css">
<link rel="stylesheet" href="blast.css">
<script src="js/jquery-ui-1.8.13.custom.min.js"></script>
<script src="jQRangeSlider.js"></script>
<script src="js/jquery.gchart.min.js"></script>
<script src="js/jquery.gchart.ext.min.js"></script>
<script src="js/jquery-geturlparams.js"></script>

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
      	getXML();
        //data = new google.visualization.DataTable();
        //data = new google.visualization.ScatterChart(document.getElementById('chart_div'));

      }
      
    </script>

</head>
<body>


<script type = "text/javascript">

function getPosition(mouseEvent, element) {
    var x, y;
    if (mouseEvent.pageX != undefined && mouseEvent.pageY != undefined) {
        x = mouseEvent.pageX;
        y = mouseEvent.pageY;
    } else {
        x = mouseEvent.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
        y = mouseEvent.clientY + document.body.scrollTop + document.documentElement.scrollTop;
    }
    return { X: x - element.offsetLeft, Y: y - element.offsetTop };
}


$(document).ready(  function()
                    {

    context = document.getElementById("blastcanvas").getContext("2d");
    initDone=0;
    yPos = 10;
    xPos = 10;
    size=50;
    step=10;
    context.font = step+"px  Courier New";
    Xseq = 200;
    canvasMaxHeight=0;
    seqdef = "Blast result";
    seqlen = 1000;
	maxSlicer = 100;
	
	iter_cur=0;
	
	//$('select#iteration_list').selectmenu({style:'dropdown'});
	
	//getXML();

	sequences = new Array();
	
	iterations = new Array();
	
	$("#iteration_list").change(function(e){
		var iter_selected="";
		$("select option:selected").each(function () {
            iter_selected = parseInt($(this).val());
        });
    iter_cur = iter_selected-1;
    sequences = getIterationHits(iter_cur);
    resetCanvas();
    
	});
	
	$("#savecanvas").click(function(e){
 		var canvasData = document.getElementById("blastcanvas").toDataURL("image/png");
 		
 		ajax = new XMLHttpRequest();
		ajax.open("POST",'savecanvas.php',false);
		ajax.onreadystatechange = savecallbackFunction;
		ajax.setRequestHeader('Content-Type', 'application/upload');
		ajax.send(canvasData );
		
		

 	});
 	

 	
	$("#sortScore").button();
	$("#sortScore").click(function(e){
		sequences.sort(sortScore);
		drawSequences(0,maxSlicer);
	});
	$("#sortFrom").button();
	$("#sortFrom").click(function(e){
		sequences.sort(sortFrom);
		drawSequences(0,maxSlicer);
	});
	
	$("#savecanvas").button();
	
	 $("#blastcanvas").click(function(e){

	var position = getPosition(e,document.getElementById("blastcanvas"));
	var y = Math.floor(position.Y/10);
    //alert("id "+y+" "+sequences[y]["hitnum"]+"-"+sequences[y]["hspnum"]);
       if($.getURLParam("file")==null) {
          xmlUrl = "demo/blast.xml";
       }
       else {
          xmlUrl = $.getURLParam("file");
       } 
    window.open("sequence.html?hitnum="+sequences[y]["hitnum"]+"&hspnum="+sequences[y]["hspnum"]+"&file="+xmlUrl);
    //http://localhost/test/sequence.html?hitnum=1
    
 	});
	

}); 


function getIterationHits(count) {
   return iterations[count]["hits"];
}

function sortScore(a,b){ 
	return b.score - a.score;
}

function sortFrom(a,b){ 
	return b.from - a.from;
}

function savecallbackFunction() {
	var result = ajax.responseText;
	window.open("img/"+result);
}

function clearCanvas() {
context.save();
context.fillStyle = "white";
context.fillRect(0, 0, document.getElementById("blastcanvas").width, document.getElementById("blastcanvas").height);
context.restore();
}



function drawSequences(min,max) {
clearCanvas();
max = parseInt(max);
min = parseInt(min);
for (i=0;i<sequences.length;i++)
{
	var sequence = sequences[i];
			  		context.save();
			  		context.fillStyle = sequence["color"];
			  		context.fillRect(0,yPos-step,1200,step);
			  		context.restore();
					context.font = step+"px  Courier New";
			  		context.fillText(sequence["id"], xPos, yPos);
			  		context.fillText(sequence["score"], xPos+Xseq-40, yPos);
			  		
			  		var from = sequence["from"];
			  		var to = sequence["to"];
	
			  		if((from>=min && from<=max)&&(to>=min && to<=max)) {
					  context.fillText(sequence["seq"], xPos+Xseq+from-min, yPos);
					}
					else if(from>=min && from<=max) {
					  context.fillText(sequence["seq"].substring(0,max-from), xPos+Xseq+from-min, yPos);
					}
					else if(to>=min && to<=max) {
					   context.fillText(sequence["seq"].substring(min-from,max-min), xPos+Xseq, yPos);
					}
					else if(from<=min && to>=max) {
					   context.fillText(sequence["seq"].substring(min-from,max-from), xPos+Xseq, yPos);
					}
					yPos+=step;			
}
yPos=10;
}


function getHits(iter_id, iteration) {
			var iter = [];
			iter["id"] = iter_id;
			
			iter["len"] = iteration.find('Iteration_query-len').text();
			
			sequences = new Array();
                iteration.find('Hit').each( function(){
                id = $(this).find('Hit_id').text().substring(0,20);
                hitnum = $(this).find('Hit_num').text();
                var randomStyle = "rgba("+Math.floor(Math.random() * 256)+","+Math.floor(Math.random() * 256)+","+Math.floor(Math.random() * 256)+",0.1)";
			  	$(this).find('Hsp').each( function(){
			  
			  		var from = $(this).find('Hsp_query-from').text();
			  		var score = $(this).find('Hsp_score').text();			  		
			  		var to = $(this).find('Hsp_query-to').text();
			  		var seq = $(this).find('Hsp_hseq').text();
			  		var hspnum = $(this).find('Hsp_num').text();
			  		
			  		var sequence = [];
			  		sequence["id"] = id;
			  		sequence["from"] = parseInt(from);
			  		sequence["to"] = parseInt(to);
			  		sequence["score"] = score;
			  		sequence["seq"] = seq;
			  		sequence["color"] = randomStyle;
			  		sequence["hitnum"]=hitnum;
			  		sequence["hspnum"]=hspnum;
			  		
			  		sequences.push(sequence);
			  		
			  		
			 	 });
			  
			  });
			  
			  iter["hits"] = sequences;
			  iterations[iter_id-1] = iter;


}

function getXML() {
if($.getURLParam("file")==null) {
 xmlUrl = "demo/blast.xml";
}
else {
 xmlUrl = $.getURLParam("file");
}
$.ajax( {
            type: "GET",
            url: xmlUrl,
            dataType: "xml",
            success: function(xml)
            {
            
            sequences = new Array();
     		var options="";
     		 $(xml).find('Iteration').each( function(){
     		 	var iter_num = $(this).find('Iteration_iter-num').text();
     		 	var iter_id = $(this).find('Iteration_query-ID').text();
     		 	var iter_def = $(this).find('Iteration_query-def').text();
     		 	options += "<option value=\""+iter_num+"\">"+iter_def+"</option>\n";
     		 	
     		 	
     		 	getHits(iter_num,$(this));
     		 
     		  });
			$("#iteration_list").html(options);
			iter_cur=0;
			sequences = getIterationHits(iter_cur);
			resetCanvas();
        }
      }); 
      
}
 
 function resetCanvas() {
 
 		document.getElementById("blastcanvas").height=(sequences.length*10)+50;
			
			
        data = new google.visualization.DataTable();
        chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
      	data.addColumn('number', 'position');
        data.addColumn('number', 'score');
        data.addRows(sequences.length);
        for (i=0;i<sequences.length;i++)
		{

        data.setValue(i, 0, sequences[i]["from"]);
        data.setValue(i, 1,  parseFloat(sequences[i]["score"]));
        }
        
        chart.draw(data, {width: 800, height: 240,
                          title: 'Position vs. Score comparison',
                          hAxis: {title: 'Position', minValue: 0},
                          vAxis: {title: 'Score', minValue: 0},
                          legend: 'none'
                         });

 
     	var iter_len = iterations[iter_cur]["len"];
            		var slider = $("#seqslider")
						.rangeSlider({ defaultValues:{min:0, max:maxSlicer}, bounds:{min:0, max:iter_len}, valueLabels: "show" })
						.bind("valuesChanging", function(event, ui){  })
						.bind("valuesChanged", function(event, ui){ if(ui.values.max - ui.values.min >maxSlicer) { alert("Warn: slice cannot extend "+maxSlicer); $("#seqslider").rangeSlider("max", ui.values.min + maxSlicer-1);  }  drawSequences(ui.values.min,ui.values.max); })
						.addClass("ui-rangeSlider-dev");

     		 	

		drawSequences(0,maxSlicer);
 
 }

 
</script>

<!--
<div id="zoomin">plus</div>
<div id="zoomout">minus</div>
-->
<div class="header">
<h1>GenOUEST Blast vizualisator</h1> 
</div>

<div class="content">

<div id="blast" class="label"></div>

<div id="iteration_div">
<form action="#">
<fieldset>
<select name="iteration_list" id="iteration_list">
</select>
</fieldset>
</form>
</div>
<div id="chart_div"></div>

<div id="sortbutton">Sort by
<input type="radio" id="sortScore" name="radio" /><label for="sortScore">Score</label>
<input type="radio" id="sortFrom" name="radio" /><label for="sortFrom">From</label>
</div>
<br/>
<div id="savecanvas">Save alignment image</div>
<div id="selector" class="selector">
<div id="seqslider" class="slider"></div>
</div>
<div id="legend">ID - SCORE - SEQUENCE, click on a sequence for details</div>
<canvas id="blastcanvas" width="1200" height="6000"></canvas>
</div>
<div class="footer"></div>

</body>
</html>

